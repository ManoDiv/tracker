<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Expense Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel (to compile React in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONS (SVG Components) ---
        const Icon = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Plus = ({ size }) => <Icon className={`w-${size/4} h-${size/4}`}><path d="M5 12h14M12 5v14"/></Icon>;
        const Trash2 = ({ size }) => <Icon className={`w-${size/4} h-${size/4}`}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>;
        const Download = ({ size }) => <Icon className={`w-${size/4} h-${size/4}`}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>;
        const Wallet = ({ className, size }) => <Icon className={className || `w-${size/4} h-${size/4}`}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></Icon>;
        const TrendingDown = ({ size }) => <Icon className={`w-${size/4} h-${size/4}`}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></Icon>;
        const Save = ({ size }) => <Icon className={`w-${size/4} h-${size/4}`}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
        const Lock = ({ size, className }) => <Icon className={className || `w-${size/4} h-${size/4}`}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></Icon>;
        const LogIn = ({ size }) => <Icon className={`w-${size/4} h-${size/4}`}><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></Icon>;
        const ArrowRightLeft = ({ size }) => <Icon className={`w-${size/4} h-${size/4}`}><path d="m16 7 4-4-4-4"/><path d="M20 3H4"/><path d="m8 17-4 4 4 4"/><path d="M4 21h16"/></Icon>;
        const CreditCard = ({ size }) => <Icon className={`w-${size/4} h-${size/4}`}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></Icon>;
        const Banknote = ({ size }) => <Icon className={`w-${size/4} h-${size/4}`}><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></Icon>;

        // --- MAIN APP COMPONENT ---
        const ExpenseTracker = () => {
            // --- AUTHENTICATION STATE ---
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [passcodeInput, setPasscodeInput] = useState('');
            const [authError, setAuthError] = useState('');

            // --- APP DATA STATE ---
            const [initialBudget, setInitialBudget] = useState(() => {
                const saved = localStorage.getItem('construction_budget');
                return saved ? parseFloat(saved) : 150000;
            });

            const [transactions, setTransactions] = useState(() => {
                const saved = localStorage.getItem('construction_transactions');
                return saved ? JSON.parse(saved) : [
                { id: 1, type: 'WITHDRAWAL', date: '2024-10-24', amount: 10000, item: 'ATM Withdrawal', category: 'Transfer' },
                { id: 2, type: 'EXPENSE', method: 'CASH', date: '2024-10-25', item: 'Cement (Cash)', category: 'Materials', amount: 4500 },
                { id: 3, type: 'EXPENSE', method: 'BANK', date: '2024-10-26', item: 'Online Order', category: 'Materials', amount: 12000 },
                ];
            });

            const [isEditingBudget, setIsEditingBudget] = useState(false);
            const [tempBudget, setTempBudget] = useState(initialBudget);

            // Form inputs
            const [activeTab, setActiveTab] = useState('EXPENSE');
            const [newItem, setNewItem] = useState('');
            const [newAmount, setNewAmount] = useState('');
            const [newDate, setNewDate] = useState(new Date().toISOString().split('T')[0]);
            const [newCategory, setNewCategory] = useState('Materials');
            const [paymentMethod, setPaymentMethod] = useState('CASH');

            // --- EFFECTS ---
            useEffect(() => {
                localStorage.setItem('construction_transactions', JSON.stringify(transactions));
            }, [transactions]);

            useEffect(() => {
                localStorage.setItem('construction_budget', initialBudget.toString());
            }, [initialBudget]);

            // --- CALCULATIONS ---
            const totalWithdrawn = transactions
                .filter(t => t.type === 'WITHDRAWAL')
                .reduce((acc, curr) => acc + (parseFloat(curr.amount) || 0), 0);

            const cashExpenses = transactions
                .filter(t => t.type === 'EXPENSE' && t.method === 'CASH')
                .reduce((acc, curr) => acc + (parseFloat(curr.amount) || 0), 0);

            const bankExpenses = transactions
                .filter(t => t.type === 'EXPENSE' && t.method === 'BANK')
                .reduce((acc, curr) => acc + (parseFloat(curr.amount) || 0), 0);

            const totalSpent = cashExpenses + bankExpenses;
            const cashOnHand = totalWithdrawn - cashExpenses;
            const bankBalance = initialBudget - totalWithdrawn - bankExpenses;

            // --- HANDLERS ---
            const handleLogin = (e) => {
                e.preventDefault();
                if (passcodeInput === '7774') {
                setIsAuthenticated(true);
                setAuthError('');
                } else {
                setAuthError('Incorrect passcode');
                }
            };

            const handleBudgetUpdate = () => {
                setInitialBudget(parseFloat(tempBudget));
                setIsEditingBudget(false);
            };

            const handleAddTransaction = (e) => {
                e.preventDefault();
                if (!newAmount) return;

                const amountVal = parseFloat(newAmount);

                let transaction = {
                id: Date.now(),
                date: newDate,
                amount: amountVal,
                };

                if (activeTab === 'EXPENSE') {
                if (!newItem) return;
                transaction = {
                    ...transaction,
                    type: 'EXPENSE',
                    item: newItem,
                    category: newCategory,
                    method: paymentMethod
                };
                } else {
                transaction = {
                    ...transaction,
                    type: 'WITHDRAWAL',
                    item: 'Cash Withdrawal',
                    category: 'Transfer',
                    method: 'BANK'
                };
                }

                setTransactions([...transactions, transaction]);
                setNewItem('');
                setNewAmount('');
            };

            const handleDelete = (id) => {
                setTransactions(transactions.filter(t => t.id !== id));
            };

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('en-LK', {
                style: 'currency',
                currency: 'LKR',
                maximumFractionDigits: 0
                }).format(amount);
            };

            const downloadCSV = () => {
                const headers = ["Date", "Type", "Item", "Category", "Payment Method", "Amount (LKR)"];
                const rows = transactions.map(t => [
                t.date, 
                t.type, 
                t.item, 
                t.category, 
                t.type === 'WITHDRAWAL' ? 'Bank to Cash' : t.method, 
                t.amount
                ]);
                
                let csvContent = "data:text/csv;charset=utf-8," 
                + headers.join(",") + "\n" 
                + rows.map(e => e.join(",")).join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "construction_tracker_sl.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- LOGIN UI ---
            if (!isAuthenticated) {
                return (
                <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4 font-sans">
                    <div className="bg-white p-8 rounded-2xl shadow-lg max-w-sm w-full border border-slate-200">
                    <div className="flex justify-center mb-6">
                        <div className="bg-blue-100 p-4 rounded-full">
                        <Lock className="text-blue-600 w-8 h-8" />
                        </div>
                    </div>
                    <h2 className="text-2xl font-bold text-center text-slate-800 mb-2">Secure Access</h2>
                    <form onSubmit={handleLogin} className="space-y-4">
                        <input
                        type="password"
                        value={passcodeInput}
                        onChange={(e) => setPasscodeInput(e.target.value)}
                        placeholder="Passcode"
                        className="w-full text-center text-2xl tracking-widest p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                        autoFocus
                        maxLength={4}
                        />
                        {authError && <div className="text-red-500 text-sm text-center font-medium animate-pulse">{authError}</div>}
                        <button type="submit" className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold flex items-center justify-center gap-2">
                        <LogIn size={20} /> Access
                        </button>
                    </form>
                    </div>
                </div>
                );
            }

            // --- DASHBOARD UI ---
            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans">
                <div className="max-w-4xl mx-auto space-y-6">
                    
                    {/* Header */}
                    <div className="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div>
                        <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                        <Wallet className="text-blue-600 w-6 h-6" />
                        Construction Expense Tracker
                        </h1>
                        <p className="text-slate-500 text-sm mt-1">Manage Bank vs Cash Expenses (Sri Lanka)</p>
                    </div>
                    <div className="flex gap-2 mt-4 md:mt-0">
                        <button onClick={downloadCSV} className="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium">
                        <Download size={16} /> Export CSV
                        </button>
                        <button onClick={() => setIsAuthenticated(false)} className="flex items-center gap-2 px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg text-sm font-medium">
                        <Lock size={16} /> Lock
                        </button>
                    </div>
                    </div>

                    {/* Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500 relative overflow-hidden">
                        <div className="flex justify-between items-start mb-2 relative z-10">
                        <span className="text-slate-500 text-sm font-medium flex items-center gap-1">
                            <CreditCard size={14}/> Bank Balance
                        </span>
                        <button onClick={() => setIsEditingBudget(!isEditingBudget)} className="text-blue-600 text-xs hover:underline">
                            {isEditingBudget ? 'Cancel' : 'Edit Initial'}
                        </button>
                        </div>
                        {isEditingBudget ? (
                        <div className="flex gap-2 relative z-10">
                            <input type="number" value={tempBudget} onChange={(e) => setTempBudget(e.target.value)} className="w-full border rounded px-2 py-1" />
                            <button onClick={handleBudgetUpdate} className="bg-blue-600 text-white p-1 rounded"><Save size={16} /></button>
                        </div>
                        ) : (
                        <div className="text-2xl font-bold text-slate-800 relative z-10">{formatCurrency(bankBalance)}</div>
                        )}
                        <div className="text-xs text-slate-400 mt-1 relative z-10">Available for Online/Card</div>
                    </div>

                    <div className="p-6 rounded-xl shadow-sm border-l-4 border-green-500 bg-green-50">
                        <span className="text-green-800 text-sm font-medium block mb-2 flex items-center gap-1">
                        <Banknote size={14}/> Cash In Hand
                        </span>
                        <div className="text-2xl font-bold text-green-900">
                        {formatCurrency(cashOnHand)}
                        </div>
                        <div className="text-xs text-green-700 mt-1">Available for Local Market</div>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500">
                        <span className="text-slate-500 text-sm font-medium block mb-2 flex items-center gap-1">
                        <TrendingDown size={14}/> Total Project Cost
                        </span>
                        <div className="text-2xl font-bold text-red-600">
                        {formatCurrency(totalSpent)}
                        </div>
                        <div className="text-xs text-slate-400 mt-1">Materials + Labor</div>
                    </div>
                    </div>

                    {/* Action Area */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="flex border-b border-slate-100">
                        <button 
                        onClick={() => setActiveTab('EXPENSE')}
                        className={`flex-1 p-4 text-sm font-medium flex items-center justify-center gap-2 ${activeTab === 'EXPENSE' ? 'text-red-600 bg-red-50 border-b-2 border-red-600' : 'text-slate-500 hover:bg-slate-50'}`}
                        >
                        <TrendingDown size={16}/> Record Expense
                        </button>
                        <button 
                        onClick={() => setActiveTab('WITHDRAWAL')}
                        className={`flex-1 p-4 text-sm font-medium flex items-center justify-center gap-2 ${activeTab === 'WITHDRAWAL' ? 'text-blue-600 bg-blue-50 border-b-2 border-blue-600' : 'text-slate-500 hover:bg-slate-50'}`}
                        >
                        <ArrowRightLeft size={16}/> Withdraw Cash
                        </button>
                    </div>

                    <div className="p-6">
                        <form onSubmit={handleAddTransaction} className="grid grid-cols-1 md:grid-cols-12 gap-4">
                        <div className="md:col-span-2">
                            <label className="block text-xs font-medium text-slate-500 mb-1">Date</label>
                            <input type="date" required value={newDate} onChange={(e) => setNewDate(e.target.value)} className="w-full p-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                        
                        {activeTab === 'EXPENSE' ? (
                            <>
                            <div className="md:col-span-3">
                                <label className="block text-xs font-medium text-slate-500 mb-1">Item</label>
                                <input type="text" required placeholder="e.g. Cement" value={newItem} onChange={(e) => setNewItem(e.target.value)} className="w-full p-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-xs font-medium text-slate-500 mb-1">Category</label>
                                <select value={newCategory} onChange={(e) => setNewCategory(e.target.value)} className="w-full p-2 border border-slate-200 rounded-lg bg-white">
                                <option>Materials</option>
                                <option>Labor</option>
                                <option>Transport</option>
                                <option>Tools</option>
                                <option>Other</option>
                                </select>
                            </div>
                            <div className="md:col-span-3">
                                <label className="block text-xs font-medium text-slate-500 mb-1">Paid Via</label>
                                <div className="flex gap-2">
                                <button type="button" onClick={() => setPaymentMethod('CASH')} className={`flex-1 py-2 px-1 text-xs rounded border ${paymentMethod === 'CASH' ? 'bg-green-100 border-green-500 text-green-700 font-bold' : 'bg-white border-slate-200 text-slate-600'}`}>
                                    Cash
                                </button>
                                <button type="button" onClick={() => setPaymentMethod('BANK')} className={`flex-1 py-2 px-1 text-xs rounded border ${paymentMethod === 'BANK' ? 'bg-blue-100 border-blue-500 text-blue-700 font-bold' : 'bg-white border-slate-200 text-slate-600'}`}>
                                    Bank/Card
                                </button>
                                </div>
                            </div>
                            </>
                        ) : (
                            <div className="md:col-span-8 flex items-center bg-blue-50 px-4 rounded-lg border border-blue-100">
                            <p className="text-sm text-blue-800">
                                <span className="font-bold">Bank Transfer â†’ Cash Wallet.</span> This will reduce your Bank Balance and increase Cash in Hand.
                            </p>
                            </div>
                        )}

                        <div className="md:col-span-2">
                            <label className="block text-xs font-medium text-slate-500 mb-1">Amount (Rs)</label>
                            <input type="number" required placeholder="0.00" value={newAmount} onChange={(e) => setNewAmount(e.target.value)} className="w-full p-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                        
                        <div className="md:col-span-12 flex justify-end">
                            <button type="submit" className={`px-6 py-2 rounded-lg text-white font-medium transition-colors flex items-center gap-2 ${activeTab === 'EXPENSE' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'}`}>
                            {activeTab === 'EXPENSE' ? <><Plus size={18}/> Add Expense</> : <><ArrowRightLeft size={18}/> Confirm Withdrawal</>}
                            </button>
                        </div>
                        </form>
                    </div>
                    </div>

                    {/* Transaction History */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="p-6 border-b border-slate-100">
                        <h3 className="font-semibold text-slate-800">Activity Log</h3>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left border-collapse">
                        <thead>
                            <tr className="bg-slate-50 text-slate-500 text-sm">
                            <th className="p-4 font-medium">Date</th>
                            <th className="p-4 font-medium">Type</th>
                            <th className="p-4 font-medium">Description</th>
                            <th className="p-4 font-medium text-right">Amount</th>
                            <th className="p-4 font-medium text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                            {[...transactions].sort((a,b) => new Date(b.date) - new Date(a.date)).map((t) => (
                            <tr key={t.id} className="hover:bg-slate-50 transition-colors">
                                <td className="p-4 text-slate-600 text-sm">{t.date}</td>
                                <td className="p-4">
                                {t.type === 'WITHDRAWAL' ? (
                                    <span className="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full font-medium">Withdrawal</span>
                                ) : (
                                    <span className={`px-2 py-1 text-xs rounded-full font-medium ${t.method === 'CASH' ? 'bg-green-100 text-green-700' : 'bg-purple-100 text-purple-700'}`}>
                                    Exp: {t.method}
                                    </span>
                                )}
                                </td>
                                <td className="p-4 text-sm text-slate-800">
                                {t.item} <span className="text-slate-400 text-xs">({t.category})</span>
                                </td>
                                <td className={`p-4 text-right font-medium ${t.type === 'WITHDRAWAL' ? 'text-blue-600' : 'text-red-600'}`}>
                                {t.type === 'WITHDRAWAL' ? '+' : '-'}{formatCurrency(t.amount)}
                                </td>
                                <td className="p-4 text-center">
                                <button onClick={() => handleDelete(t.id)} className="text-slate-400 hover:text-red-600 p-1 hover:bg-red-50 rounded">
                                    <Trash2 size={16} />
                                </button>
                                </td>
                            </tr>
                            ))}
                            {transactions.length === 0 && (
                            <tr><td colSpan="5" className="p-8 text-center text-slate-400">No transactions yet.</td></tr>
                            )}
                        </tbody>
                        </table>
                    </div>
                    </div>

                </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExpenseTracker />);
    </script>
</body>
</html>